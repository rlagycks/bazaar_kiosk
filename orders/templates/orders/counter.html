{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>카운터 - 배치 주문</title>
  <link rel="stylesheet" href="{% static 'orders/ui/styles.css' %}">
</head>
<body>

<div class="screen active">
  <div class="header">
    <h2>카운터 모드</h2>
    <a class="btn btn-secondary" href="{% url 'orders:logout' %}">로그아웃</a>
  </div>

  <div class="content">

    <div class="channel-selection">
      <h3>주문 채널 선택</h3>
      <div class="channel-tabs">
        <button class="tab-btn active" data-channel="TAKEOUT" id="btnTakeout">포장(TAKEOUT)</button>
        <button class="tab-btn" data-channel="BOOTH" id="btnBooth">부스(BOOTH)</button>
        <button class="tab-btn" data-channel="BOTH" id="btnBoth">동시 선택</button>
      </div>
    </div>

    <div class="menu-categories">
      <div>
        <div class="category-tabs" id="catTabs"></div>
        <div class="menu-items" id="menuGrid"></div>
      </div>

      <div class="order-summary">
        <h4>장바구니</h4>
        <div class="order-items" id="cart"></div>

        <div class="form-group">
          <label for="note">요청사항</label>
          <input id="note" class="form-control" placeholder="예) 덜 맵게"/>
        </div>

        <div class="order-total">
          <strong>총액: <span id="total">0원</span></strong>
        </div>
        <button class="btn btn-primary" id="submit">주문 생성</button>
        <div id="msg" style="margin-top:10px;color:#666;"></div>
      </div>
    </div>

    <div class="recent-orders">
      <h4>최근 주문 (20건)</h4>
      <div class="recent-orders-list" id="recent"></div>
    </div>
  </div>
</div>

<script>
  // --- helpers ---
  function getCookie(name){
    const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m?m.pop():'';
  }
  const CSRF = getCookie('csrftoken');
  const KRW = function(n){return (n||0).toLocaleString('ko-KR');};

  // --- state ---
  let channelMode = 'TAKEOUT'; // TAKEOUT | BOOTH | BOTH
  let allItems = []; // {id,name,price,category_id, category_name, flags...}
  let categories = []; // [{id,name}]
  let cartItems = []; // [{menu_item_id, name, price, qty}]

  // --- UI wiring (tabs) ---
  function activateChannel(mode){
    channelMode = mode;
    for (const el of document.querySelectorAll('.channel-tabs .tab-btn')) {
      el.classList.toggle('active', el.dataset.channel === (mode==='BOTH'?'BOTH':mode));
    }
    loadMenus(); // 채널 바뀌면 메뉴 재로드(필터)
  }
  document.getElementById('btnTakeout').onclick = ()=>activateChannel('TAKEOUT');
  document.getElementById('btnBooth').onclick   = ()=>activateChannel('BOOTH');
  document.getElementById('btnBoth').onclick    = ()=>activateChannel('BOTH');

  // --- load menus (scope=COUNTER, channel=optional) ---
  async function loadMenus(){
    const params = new URLSearchParams({scope:'COUNTER'});
    if (channelMode==='TAKEOUT' || channelMode==='BOOTH') params.set('channel', channelMode);
    // BOTH면 채널 파라미터 없이 전체(카운터 가시성) 로드
    const r = await fetch('/orders/menus/?'+params.toString());
    const d = await r.json();
    categories = (d.categories||[]);
    allItems = (d.items||[]);
    renderCategories();
    renderMenuGrid();
  }

  function renderCategories(){
    const wrap = document.getElementById('catTabs');
    if (!categories.length){ wrap.innerHTML=''; return; }
    const activeId = + (wrap.querySelector('.tab-btn.active')?.dataset.id || categories[0].id);
    wrap.innerHTML = categories.map(function(c){
      return '<button class="tab-btn'+(c.id===activeId?' active':'')+'" data-id="'+c.id+'">'+c.name+'</button>';
    }).join('');
    for (const b of wrap.querySelectorAll('.tab-btn')){
      b.onclick = function(){
        for (const x of wrap.querySelectorAll('.tab-btn')) x.classList.remove('active');
        b.classList.add('active');
        renderMenuGrid();
      };
    }
  }

  function currentCategoryId(){
    const btn = document.querySelector('#catTabs .tab-btn.active');
    return btn ? +btn.dataset.id : (categories[0]?.id || null);
  }

  function renderMenuGrid(){
    const catId = currentCategoryId();
    const grid = document.getElementById('menuGrid');
    const list = allItems.filter(function(m){ return !catId || m.category_id===catId; });
    grid.innerHTML = list.map(function(m){
      return '<div class="menu-item" data-id="'+m.id+'">'
          + '<h4>'+m.name+'</h4>'
          + '<div class="price">₩'+KRW(m.price)+'</div>'
        + '</div>';
    }).join('');
    for (const el of grid.querySelectorAll('.menu-item')){
      el.onclick = function(){
        const id = +el.dataset.id;
        const mi = allItems.find(function(x){return x.id===id;});
        addToCart(mi);
      }
    }
  }

  function addToCart(mi){
    if (!mi) return;
    const idx = cartItems.findIndex(function(x){return x.menu_item_id===mi.id;});
    if (idx>=0){ cartItems[idx].qty += 1; }
    else { cartItems.push({menu_item_id: mi.id, name: mi.name, price: mi.price, qty: 1}); }
    renderCart();
  }
  function removeFromCart(id){
    cartItems = cartItems.filter(function(x){return x.menu_item_id!==id;});
    renderCart();
  }
  function changeQty(id, delta){
    const it = cartItems.find(function(x){return x.menu_item_id===id;});
    if (!it) return;
    it.qty = Math.max(1, it.qty + delta);
    renderCart();
  }
  function renderCart(){
    const el = document.getElementById('cart');
    el.innerHTML = cartItems.map(function(it){
      return '<div class="order-item">'
        + '<div>'+it.name+' × '+it.qty+'</div>'
        + '<div>'
          + '<button class="btn btn-secondary btn-sm" style="padding:6px 10px" onclick="changeQty('+it.menu_item_id+',-1)">－</button> '
          + '<button class="btn btn-secondary btn-sm" style="padding:6px 10px" onclick="changeQty('+it.menu_item_id+',1)">＋</button> '
          + '<button class="btn btn-secondary btn-sm" style="padding:6px 10px" onclick="removeFromCart('+it.menu_item_id+')">삭제</button>'
        + '</div>'
      + '</div>';
    }).join('');
    const total = cartItems.reduce(function(s,it){return s + it.price*it.qty;}, 0);
    document.getElementById('total').textContent = '₩'+KRW(total);
  }

  // --- submit batch ---
  document.getElementById('submit').onclick = async function(){
    const msg = document.getElementById('msg');
    const note = (document.getElementById('note').value||'').trim();
    if (!cartItems.length){ msg.textContent='아이템을 추가하세요.'; return; }
    const itemsPayload = cartItems.map(function(x){return {menu_item_id:x.menu_item_id, qty:x.qty};});
    const orders = [];
    if (channelMode==='TAKEOUT' || channelMode==='BOTH') orders.push({order_type:'TAKEOUT', items:itemsPayload, note:note});
    if (channelMode==='BOOTH'   || channelMode==='BOTH') orders.push({order_type:'BOOTH',   items:itemsPayload, note:note});
    try{
      const r = await fetch('/orders/api/orders/batch', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken':CSRF},
        body: JSON.stringify({orders:orders})
      });
      if (!r.ok){ throw new Error(await r.text() || ('HTTP '+r.status)); }
      const d = await r.json();
      msg.style.color = '#059669';
      msg.textContent = '생성 성공: ' + (d.results||[]).map(function(o){
        return o.order_type + (o.pickup_no? ' #'+o.pickup_no : '');
      }).join(', ');
      cartItems = []; renderCart(); document.getElementById('note').value='';
      loadRecent();
    }catch(e){
      msg.style.color = '#DC2626';
      msg.textContent = '실패: '+e.message;
    }
  };

  // --- recent list (5s) ---
  async function loadRecent(){
    const r = await fetch('/orders/api/orders/?limit=20&types=TAKEOUT,BOOTH');
    const d = await r.json();
    const html = (d.results||[]).map(function(o){
      const itemsText = (o.items||[]).map(function(i){return i.menu_item_name+'×'+i.qty;}).join(', ');
      const timeText = new Date(o.created_at).toLocaleTimeString();
      return '<div class="recent-order-item">'
        + '<div><strong>'+o.order_type+(o.pickup_no? ' #'+o.pickup_no:'')+'</strong><br>'
        + '<span class="muted">'+itemsText+'</span></div>'
        + '<div>₩'+KRW(o.total_price||0)+'<br><span class="muted">'+timeText+'</span></div>'
      + '</div>';
    }).join('');
    document.getElementById('recent').innerHTML = html || '<div class="muted">주문 없음</div>';
  }

  // init
  loadMenus();
  loadRecent();
  setInterval(loadRecent, 5000);
</script>

</body>
</html>