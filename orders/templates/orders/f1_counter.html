{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>1층 카운터</title>
  <link rel="stylesheet" href="{% static 'orders/ui/styles.css' %}">
  <style>
    .page-wrap{max-width:1200px;margin:0 auto;padding:12px;}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
    .header h2{margin:0;font-size:20px;}
    .content{display:grid;grid-template-columns:1.2fr 1fr;gap:12px;}
    .panel{background:#fff;border:1px solid var(--color-border, #e5e7eb);border-radius:8px;padding:12px;}
    .panel h4{margin:0 0 8px 0;font-size:16px}
    .recent-orders-list{display:flex;flex-direction:column;gap:8px;max-height:70vh;overflow:auto;}
    .recent-order-item{
      display:flex;justify-content:space-between;gap:8px;align-items:center;
      padding:10px;border:1px solid var(--color-border, #e5e7eb);border-radius:8px;background:#fafafa;
    }
    .muted{color:#6b7280;font-size:12px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#e5e7eb;}
    .badge.ready{background:#16a34a;color:#fff}
    .badge.preparing{background:#f59e0b;color:#1f2937}
    .menu-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;max-height:36vh;overflow:auto;margin-bottom:8px;}
    .menu-tile{border:1px solid var(--color-border,#e5e7eb);border-radius:8px;padding:10px;background:#ffffff}
    .menu-tile .name{font-weight:600}
    .menu-tile .price{font-size:12px;color:#6b7280}
    .menu-tile .actions{margin-top:8px;display:flex;gap:6px}
    .btn{display:inline-flex;align-items:center;justify-content:center;height:36px;padding:0 12px;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:#2563eb;color:#fff;border-color:#2563eb}
    .btn-danger{background:#ef4444;color:#fff;border-color:#ef4444}
    .order-items{display:flex;flex-direction:column;gap:6px}
    .order-item{display:flex;align-items:center;justify-content:space-between;border:1px solid #e5e7eb;border-radius:8px;padding:8px;background:#fff}
    .order-item .left{display:flex;flex-direction:column}
    .order-item .qty-ctrl{display:flex;gap:6px;align-items:center}
    .order-total{margin-top:8px;font-size:14px}
    .form-group{margin-top:8px}
    .form-row{display:flex;gap:8px}
    .form-control{width:100%;height:40px;border:1px solid #d1d5db;border-radius:8px;padding:0 10px}
    .footer-actions{margin-top:10px;display:flex;gap:8px}
    @media (max-width:900px){ .content{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <div class="page-wrap">
    <div class="header">
      <h2>1층 카운터</h2>
      <div class="muted">부스 주문 저장 → 1층 부스 화면에 5초 내 반영</div>
    </div>

    <div class="content">
      <!-- 왼쪽: 최근 주문 -->
      <section class="panel">
        <h4>최근 주문(1층 부스)</h4>
        <div id="recent-list" class="recent-orders-list">
          <div class="muted">로딩 중…</div>
        </div>
      </section>

      <!-- 오른쪽: 메뉴 + 장바구니 + 결제 + 주문저장 -->
      <aside class="panel">
        <h4>메뉴(부스)</h4>
        <div id="menu-grid" class="menu-grid"></div>

        <h4 style="margin-top:8px;">장바구니</h4>
        <div id="cart-items" class="order-items"></div>
        <div class="order-total"><strong>총액: <span id="total-amount">0원</span></strong></div>

        <div class="form-group">
          <label>결제 방식</label>
          <div class="form-row">
            <label style="display:flex;gap:6px;align-items:center;">
              <input type="radio" name="pay" value="CASH" checked> 현금
            </label>
            <label style="display:flex;gap:6px;align-items:center;">
              <input type="radio" name="pay" value="TICKET"> 티켓
            </label>
          </div>
        </div>

        <!-- 항상 표시: 티켓도 받은 금액 입력 -->
        <div class="form-group" id="cash-wrap">
          <label for="cash-in">받은 금액</label>
          <input id="cash-in" class="form-control" placeholder="예) 10000" inputmode="numeric">
          <div class="order-total"><strong>거스름돈: <span id="change-amount">0원</span></strong></div>
        </div>

        <div class="footer-actions">
          <button id="btn-reset" class="btn">초기화</button>
          <button id="btn-submit" class="btn btn-primary" style="flex:1">주문 저장</button>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // ---------- 유틸 ----------
    const KRW = (n)=> (Number(n)||0).toLocaleString('ko-KR');
    function getCookie(name){
      const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
      return m ? m.pop() : '';
    }
    async function getJSON(url){
      const r = await fetch(url,{credentials:'same-origin'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }
    async function postJSON(url, data){
      const r = await fetch(url,{
        method:'POST',credentials:'same-origin',
        headers:{
          'Content-Type':'application/json',
          'X-CSRFToken': getCookie('csrftoken') || ''
        },
        body: JSON.stringify(data||{})
      });
      if(!r.ok){
        const t = await r.text().catch(()=> '');
        throw new Error(t || ('HTTP '+r.status));
      }
      return r.json();
    }

    // ---------- 상태 ----------
    const CART = new Map(); // id -> {id,name,price,qty}
    const els = {
      menu: document.getElementById('menu-grid'),
      cart: document.getElementById('cart-items'),
      total: document.getElementById('total-amount'),
      change: document.getElementById('change-amount'),
      cash: document.getElementById('cash-in'),
      recent: document.getElementById('recent-list'),
      btnSubmit: document.getElementById('btn-submit'),
      btnReset: document.getElementById('btn-reset')
    };

    // ---------- 메뉴 ----------
    async function loadMenus(){
      try{
        const d = await getJSON("{% url 'orders:menus' %}?scope=COUNTER&channel=BOOTH");
        const items = d.items||[];
        els.menu.innerHTML = items.map(m=>`
          <div class="menu-tile" data-id="${m.id}" data-name="${m.name}" data-price="${m.price}">
            <div class="name">${m.name}</div>
            <div class="price">₩${KRW(m.price)}</div>
            <div class="actions">
              <button class="btn" onclick="addItem(${m.id}, '${m.name.replace(/'/g,"\\'")}', ${m.price})">+1</button>
              <button class="btn" onclick="promptQty(${m.id}, '${m.name.replace(/'/g,"\\'")}', ${m.price})">수량</button>
            </div>
          </div>
        `).join('') || '<div class="muted">부스 메뉴가 없습니다</div>';
      }catch(e){
        els.menu.innerHTML = '<div class="muted">메뉴 로드 실패</div>';
      }
    }

    // ---------- 장바구니 ----------
    function addItem(id, name, price, delta=1){
      const row = CART.get(id) || {id, name, price, qty:0};
      row.qty = Math.max(0, (row.qty||0) + delta);
      if(row.qty===0) CART.delete(id); else CART.set(id, row);
      renderCart();
    }
    function setItemQty(id, qty){
      qty = Math.max(0, Number(qty)||0);
      const row = CART.get(id);
      if(!row) return;
      row.qty = qty;
      if(qty===0) CART.delete(id);
      renderCart();
    }
    function promptQty(id, name, price){
      const cur = CART.get(id)?.qty || 1;
      const v = prompt(`${name} 수량`, cur);
      if(v==null) return;
      setItemQty(id, Number(v)||0);
    }
    function calcTotals(){
      let total = 0;
      CART.forEach(r=> total += (r.qty * r.price));
      return {total};
    }
    function renderCart(){
      const arr = Array.from(CART.values());
      els.cart.innerHTML = arr.map(r=>`
        <div class="order-item">
          <div class="left">
            <div><strong>${r.name}</strong></div>
            <div class="muted">₩${KRW(r.price)} × ${r.qty} = ₩${KRW(r.price*r.qty)}</div>
          </div>
          <div class="qty-ctrl">
            <button class="btn" onclick="addItem(${r.id}, '${r.name.replace(/'/g,"\\'")}', ${r.price}, -1)">－</button>
            <div style="min-width:2em;text-align:center">${r.qty}</div>
            <button class="btn" onclick="addItem(${r.id}, '${r.name.replace(/'/g,"\\'")}', ${r.price}, +1)">＋</button>
            <button class="btn btn-danger" onclick="setItemQty(${r.id}, 0)">삭제</button>
          </div>
        </div>
      `).join('') || '<div class="muted">장바구니 비어 있음</div>';

      const {total} = calcTotals();
      els.total.textContent = KRW(total) + '원';
      recalcChange();
    }

    // ---------- 결제/거스름돈 ----------
    function currentPayMethod(){
      return (document.querySelector('input[name="pay"]:checked')?.value || 'CASH');
    }
    // 결제 방식과 무관하게 받은 금액을 입력받고, 항상 거스름돈 계산
    function recalcChange(){
      const {total} = calcTotals();
      const got = Number(els.cash.value||0);
      const change = Math.max(0, got - total);
      els.change.textContent = KRW(change)+'원';
    }
    function onPayMethodChange(){
      // now: 방식 전환 시에도 단순히 재계산만 수행
      recalcChange();
    }

    // ---------- 최근 주문 ----------
    function badge(status){
      return status==='READY'
        ? '<span class="badge ready">준비완료</span>'
        : '<span class="badge preparing">준비중</span>';
    }
    async function loadRecent(){
      try{
        const d = await getJSON("{% url 'orders:orders-collection' %}?floor=F1&limit=20&types=BOOTH");
        const arr = d.results||[];
        els.recent.innerHTML = arr.map(o=>`
          <div class="recent-order-item">
            <div>
              <div><strong>부스${o.order_no ? ' #'+o.order_no : ''}</strong> ${badge(o.status)}</div>
              <div class="muted">${(o.items||[]).map(i=>`${i.menu_item_name}×${i.qty}`).join(', ')}</div>
            </div>
            <div><strong>₩${KRW(o.total_price||0)}</strong></div>
          </div>
        `).join('') || '<div class="muted">최근 주문 없음</div>';
      }catch(e){
        els.recent.innerHTML = '<div class="muted">최근 주문 로드 실패</div>';
      }
    }

    // ---------- 저장 ----------
    async function onSubmit(){
      const items = Array.from(CART.values()).map(r=>({menu_item_id:r.id, qty:r.qty}));
      if(items.length===0){ alert('메뉴를 선택해 주세요.'); return; }

      const pay = currentPayMethod();
      const {total} = calcTotals();
      const received = Number(els.cash.value||0);   // 현금/티켓 공통
      if(!(received >= total)){
        if(!confirm('받은 금액이 총액보다 적습니다. 계속할까요?')) return;
      }

      els.btnSubmit.disabled = true;
      try{
        await postJSON("{% url 'orders:orders-collection' %}", {
          floor: 'F1',
          order_type: 'BOOTH',
          source: 'F1_COUNTER',
          is_takeout: true,
          payment_method: pay,
          received_amount: received,
          note: '',
          items
        });
        resetAll(true);
        loadRecent();
      }catch(e){
        alert('저장 실패: ' + (e.message||e));
      }finally{
        els.btnSubmit.disabled = false;
      }
    }

    // ---------- 초기화 ----------
    function resetAll(clearCart=false){
      if(clearCart){ CART.clear(); }
      renderCart();               // 합계/거스름돈 0으로 갱신
      els.cash.value = '';        // 입력값 비움
      recalcChange();             // 0원 표시 보장
    }

    // ---------- init ----------
    document.addEventListener('DOMContentLoaded', ()=>{
      loadMenus();
      loadRecent();
      renderCart();
      setInterval(loadRecent, 5000);

      els.cash.addEventListener('input', recalcChange);
      document.querySelectorAll('input[name="pay"]').forEach(r=> r.addEventListener('change', onPayMethodChange));
      els.btnSubmit.addEventListener('click', onSubmit);
      els.btnReset.addEventListener('click', ()=> resetAll(true));
    });

    // 전역 헬퍼 노출
    window.addItem = addItem;
    window.promptQty = promptQty;
    window.setItemQty = setItemQty;
  </script>
</body>
</html>