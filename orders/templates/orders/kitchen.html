{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>지하 주방</title>
  <link rel="stylesheet" href="{% static 'orders/ui/styles.css' %}">
  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:12px;}
    .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .hdr h2{margin:0;font-size:20px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (min-width:980px){.grid{grid-template-columns:repeat(3,minmax(0,1fr));}}
    .card{background:#fff;border:1px solid var(--color-border,#e5e7eb);border-radius:10px;padding:12px}
    .title{font-weight:700;font-size:16px;margin-bottom:4px}
    .muted{color:#6b7280;font-size:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;height:38px;padding:0 12px;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
    .btn-primary{background:#2563eb;color:#fff;border-color:#2563eb}
    .row{display:flex;justify-content:space-between;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <h2>지하 주방</h2>
      <div class="muted">준비중 목록 · 탭하면 “준비완료”</div>
    </div>

    <div id="grid" class="grid"></div>
  </div>

  <script>
    const KRW = n => (Number(n)||0).toLocaleString('ko-KR');
    function getCookie(name){
      const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return m?m.pop():'';
    }
    async function getJSON(url){
      const r=await fetch(url,{credentials:'same-origin'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();
    }
    async function patchJSON(url, data){
      const r=await fetch(url,{method:'PATCH',credentials:'same-origin',headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')||''},body:JSON.stringify(data||{})});
      if(!r.ok){const t=await r.text().catch(()=> '');throw new Error(t||('HTTP '+r.status));}
      return r.json();
    }

    async function load(){
      const url = "{% url 'orders:orders-collection' %}" + "?floor=B1&status=PREPARING&types=DINE_IN,TAKEOUT&limit=100";
      try{
        const d = await getJSON(url);
        const list = d.results || [];
        var html = '';
        for (var k=0;k<list.length;k++){
          const o = list[k];
          const isTakeout = (o.is_takeout || o.order_type==='TAKEOUT');
          const title = isTakeout ? '포장' : ('테이블 ' + (o.table ? (o.table.number || o.table.id) : '-'));
          const items = (o.items||[]).map(function(i){ return i.menu_item_name + '×' + i.qty; }).join(', ');
          html += ''
          + '<div class="card" onclick="markReady('+o.id+')">'
          +   '<div class="title">'+title+'</div>'
          +   '<div class="muted">'+items+'</div>'
          + '</div>';
        }
        document.getElementById('grid').innerHTML = html || '<div class="muted">대기 주문 없음</div>';
      }catch(e){
        document.getElementById('grid').innerHTML = '<div class="muted">로딩 실패</div>';
      }
    }

    async function markReady(id){
      try{
        await patchJSON("{% url 'orders:order-status' 0 %}".replace('/0/','/'+id+'/'), {status:'READY'});
      }catch(e){ alert('상태 변경 실패'); }
      load();
    }

    window.markReady = markReady;
    document.addEventListener('DOMContentLoaded', function(){
      load();
      setInterval(load, 5000);
    });
  </script>
</body>
</html>